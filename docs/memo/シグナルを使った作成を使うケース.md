## 💡 シグナルを使うべき２つの具体的なケース

シグナルは、**モデルが DB に保存されたという「出来事」**をトリガーに、**疎結合な処理**を実行するのに最適です。

### ケース 1: 関連データの自動作成・初期化 (データの整合性維持)

これは、**ユーザーが入力しない**データを自動で用意するケースです。

| 処理したい内容             | 適切な方法                                                                                                                                   | 理由 (なぜシグナルか)                                                                                                                                |
| :------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------- |
| **ユーザー設定の場所取り** | ユーザー (`User`) 作成後、すぐに **空の設定レコード** (`UserProfile`, `UserSettings`) を DB に作成する。                                     | **他の機能がそのレコードの存在を前提としている**が、ユーザー入力はまだ不要な場合。メール通知や設定画面へのアクセス時にエラーが出ないようにするため。 |
| **在庫トラッキング**       | 新しい商品 (`Product`) が DB に作成されたら、すぐにその商品に対応する **在庫管理レコード** (`InventoryRecord`) を `0` の状態で自動作成する。 | 手動で在庫レコードを作る必要がなく、システム内でデータが欠落しないことが保証される。                                                                 |

### ケース 2: ログ記録やキャッシュなどの副作用 (疎結合性の維持)

これは、メインの処理の成功/失敗に関係なく、**情報提供やパフォーマンス改善**のために行う処理です。

| 処理したい内容               | 適切な方法                                                                                                           | 理由 (なぜシグナルか)                                                                                         |
| :--------------------------- | :------------------------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------ |
| **履歴の自動記録**           | 重要な取引 (`Transaction`) が保存されるたびに、その変更内容を **履歴テーブル** (`HistoricalData`) に自動で記録する。 | 取引処理コードの中に履歴記録のコードを直接書く必要がなくなり、**コードがスッキリする**。                      |
| **キャッシュのクリア**       | カテゴリデータ (`Category`) が更新されたら、そのカテゴリが使われている **Web ページのキャッシュ**を自動で削除する。  | ビューやサービスコードが、キャッシュシステム（例: Redis）の知識を持つ必要がなくなり、**依存性が分離**される。 |
| **全文検索インデックス更新** | 記事 (`Article`) が保存されたら、その内容を **Elasticsearch** などの検索エンジンに自動で反映する。                   | 記事保存ロジックは DB 保存だけに集中し、外部システムとの連携はシグナルに任せられる。                          |

---

## 🚫 シグナルを使ってはいけない明確な例

逆に、**シグナルを使ってはいけない**のは、その処理が**ユーザーの入力検証**や**メインのビジネスロジックの成功/失敗**に強く関わる場合です。

| してはいけない処理           | 適切な場所                                        | 理由 (なぜシグナルではないか)                                                                                                                                                           |
| :--------------------------- | :------------------------------------------------ | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **フォーム入力データの保存** | **View** の `form_valid` または **Service Layer** | ユーザーが入力したデータにエラーがあった場合、シグナルではそれをキャッチしてユーザーに適切に伝えることができないため。                                                                  |
| **決済処理の実行**           | **Service Layer**                                 | 決済が失敗した場合、商品購入全体をロールバック（元に戻す）する必要があります。シグナル処理はメインのトランザクションから外れて実行されることがあり、**成功/失敗の保証ができない**ため。 |

---

## 💡 プロフィールデータとシグナルの関係

### 1. なぜ在庫ではシグナルが適切か？

- **在庫レコード**は、商品が作成されたら**無条件**に作成されるべきデータであり、その初期値は常に「0」など**システム側で決定**されます。ユーザーの入力は不要です。

### 2. なぜプロフィールではシグナルが一般的でないか？

プロフィールデータには、**ユーザーの入力が必要な情報**（表示名、自己紹介など）が含まれます。

| 要因             | 理由                                                                                                                                                              | 結論                                                                                                       |
| :--------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------- | :--------------------------------------------------------------------------------------------------------- |
| **ユーザー入力** | プロフィールの多くのフィールドは、ユーザーの**意思や入力**に依存する。                                                                                            | **フォーム/サービス層**で処理すべき。                                                                      |
| **データ初期化** | ユーザー登録時にプロフィールを必須にする場合、そのデータは**空ではなく**、ユーザーが入力したデータで初期化されるべき。                                            | **フォーム/サービス層**で、`M_User` と `M_UserProfile` を同時に**作成**すべき。                            |
| **紐づけ**       | プロフィールは必ずユーザーに紐づきますが、その**紐づけ（`OneToOneField`）**は、**作成**時に行うべき責務であり、シグナルかメインロジックかのどちらかが担当します。 | シグナルで自動作成する場合、その紐づけは**自動**で行われますが、**ユーザー入力を無視した作成**になります。 |

### 3. なぜあなたのプロジェクトではシグナルを残したのか？

あなたのプロジェクトでシグナルを残した設計（空のプロフィール作成）は、**理想的な設計**ではなく、**既存のシステム（パスワードリセットメールなど）を壊さない**ための**影響範囲を最小化する設計**として採用されました。

- **理想:** シグナルを削除し、登録時にプロフィールを入力させる（または初回設定ビューでプロフィールを新規作成させる）。
- **現実:** シグナルを削除すると、依存する既存のメール通知機能がエラーを出す。

したがって、**一般論としてプロフィール作成にシグナルはあまり使いません**が、あなたのケースでは**「既存機能維持」**という強い制約から残されています。
