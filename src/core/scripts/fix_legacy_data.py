import os
import sys

import django
from django.contrib.auth import get_user_model
from django.db import transaction
from django.utils import timezone

# ----------------------------------------------------
# 1. Djangoç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— (å¿…é ˆ)
# ----------------------------------------------------
# manage.py shellã‹ã‚‰å®Ÿè¡Œã™ã‚‹å ´åˆã€ã“ã®è¡Œã¯é€šå¸¸ä¸è¦ã§ã™ãŒã€
# å¤–éƒ¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨ã—ã¦å®Ÿè¡Œã™ã‚‹å ´åˆã®ãŸã‚ã«è¨˜è¿°ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
# sys.path.append(os.path.dirname(os.path.abspath(__file__)) + '/../..')
# os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
# django.setup()
# (â€» manage.py shellå†…ã‹ã‚‰å®Ÿè¡Œã™ã‚‹ãŸã‚ã€ä¸Šè¨˜ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã¾ãŸã¯å‰Šé™¤ã‚’æŽ¨å¥¨)

# ----------------------------------------------------
# 2. å®šæ•°ã¨åˆæœŸè¨­å®š
# ----------------------------------------------------
User = get_user_model()


def fix_legacy_unverified_users(dry_run=True):
    """
    å¤ã„ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ç§»è¡Œã•ã‚ŒãŸã€is_active=Trueã ãŒæœªèªè¨¼ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’
    æ–°ã—ã„åŽ³æ ¼ãƒ¢ãƒ‡ãƒ«ï¼ˆis_active=Falseï¼‰ã«è¨­å®šã—ç›´ã™ã€‚
    """
    # ç§»è¡Œå‰ã®å¤ã„ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã™ã‚‹æ¡ä»¶
    # (ã“ã“ã§ã¯ is_active=True ã§ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã«é–¢é€£ã™ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ãŒãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å¯¾è±¡ã¨ã™ã‚‹)

    # ðŸ’¡ æ³¨æ„: å®Ÿéš›ã®ã‚¯ã‚¨ãƒªã¯ã€å¤ã„ã‚·ã‚¹ãƒ†ãƒ ã®çŠ¶æ…‹ã«ã‚ˆã£ã¦ç•°ãªã‚Šã¾ã™ã€‚
    # ä¾‹: å¤ã„ã‚·ã‚¹ãƒ†ãƒ ã§ is_email_verified ãŒã‚ã‚Šã€ãã‚ŒãŒ False ã®ã¾ã¾æ®‹ã£ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã©

    # ä»®ã®ã‚¯ã‚¨ãƒª: is_active=True ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¨å“¡ã‚’å¯¾è±¡ã¨ã—ã€æ‰‹å‹•ã§çŠ¶æ…‹ã‚’åˆ¤å®š
    target_users = User.objects.filter(
        is_active=True,
        date_joined__lt=timezone.datetime(2025, 1, 1, tzinfo=timezone.utc),
    )

    unverified_count = 0
    updated_count = 0

    print(f"--- ãƒ¬ã‚¬ã‚·ãƒ¼ãƒ‡ãƒ¼ã‚¿ä¿®æ­£ã‚¹ã‚¯ãƒªãƒ—ãƒˆé–‹å§‹ ---")
    print(f"å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼å€™è£œæ•°: {target_users.count()}")
    print(f"ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ãƒ¢ãƒ¼ãƒ‰: {'æœ‰åŠ¹' if dry_run else 'ç„¡åŠ¹'}")

    # ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¢ºä¿
    try:
        with transaction.atomic():
            for user in target_users.iterator():
                # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå®Ÿéš›ã«ãƒ¡ãƒ¼ãƒ«èªè¨¼ã‚’å—ã‘ã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèªã™ã‚‹é«˜åº¦ãªãƒ­ã‚¸ãƒƒã‚¯ã‚’ã“ã“ã«è¨˜è¿°
                # ä¾‹: if not user.has_active_activation_token():  ãªã©

                # ------------------------------------------------------------
                # âš ï¸ ãƒ‡ãƒ¼ã‚¿ã®å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯ (ãƒ€ãƒŸãƒ¼ãƒ­ã‚¸ãƒƒã‚¯)
                # ------------------------------------------------------------
                # å®Ÿéš›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€ãƒˆãƒ¼ã‚¯ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ãªã©ã‚’å‚ç…§ã—ã€
                # èªè¨¼æ¸ˆã¿ã‹å¦ã‹ã‚’æ­£ç¢ºã«åˆ¤å®šã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¨˜è¿°ã—ã¾ã™ã€‚
                # ã“ã“ã§ã¯ã€ç°¡ç•¥åŒ–ã®ãŸã‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå¶æ•°ãªã‚‰æœªèªè¨¼ã¨ä»®å®šã—ã¾ã™ã€‚

                if user.pk % 2 == 0:
                    unverified_count += 1

                    if not dry_run:
                        # åŽ³æ ¼ãƒ¢ãƒ‡ãƒ«ã«åŸºã¥ã is_active=False ã«è¨­å®š
                        user.is_active = False
                        user.save(update_fields=["is_active"])
                        updated_count += 1
                        print(
                            f"  [UPDATE] ãƒ¦ãƒ¼ã‚¶ãƒ¼ID {user.pk} ({user.email}) ã® is_active ã‚’ False ã«è¨­å®šã—ã¾ã—ãŸã€‚"
                        )
                    else:
                        print(
                            f"  [DRY RUN] ãƒ¦ãƒ¼ã‚¶ãƒ¼ID {user.pk} ({user.email}) ã¯ is_active=False ã«è¨­å®šã•ã‚Œã‚‹ã¹ãã§ã™ã€‚"
                        )

            if dry_run:
                print("\n-> ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³çµ‚äº†ã€‚å¤‰æ›´ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«åæ˜ ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
            else:
                print(
                    f"\n-> ä¿®æ­£å®Œäº†ã€‚{updated_count} ä»¶ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® is_active ãŒ False ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚"
                )

    except Exception as e:
        print(f"\nè‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã€å‡¦ç†ã‚’ä¸­æ–­ã—ã¾ã—ãŸ: {e}")
        # transaction.atomic() ã®å¤–å´ã§ raise ã™ã‚‹ã“ã¨ã§ã€ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒä¿è¨¼ã•ã‚Œã¾ã™
        raise


# ----------------------------------------------------
# 3. å®Ÿè¡Œã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ
# ----------------------------------------------------
if __name__ == "__main__":
    # å®Ÿè¡Œå‰ã«æœ€çµ‚ç¢ºèªã‚’è¡Œã†
    confirmation = input(
        "è­¦å‘Š: ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ is_active ãƒ•ãƒ©ã‚°ã‚’å¤‰æ›´ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ (yes/no): "
    )

    if confirmation.lower() == "yes":
        # ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ï¼ˆå½±éŸ¿ç¯„å›²ã®ç¢ºèªï¼‰ã‚’å®Ÿè¡Œ
        fix_legacy_unverified_users(dry_run=True)

        # å®Ÿéš›ã®å®Ÿè¡Œ
        final_confirmation = input(
            "ä¸Šè¨˜ã®çµæžœã«åŸºã¥ãã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’**å®Ÿéš›ã«æ›´æ–°**ã—ã¾ã™ã‹ï¼Ÿ (yes/NO): "
        )
        if final_confirmation.lower() == "yes":
            fix_legacy_unverified_users(dry_run=False)
        else:
            print("ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸã€‚")
    else:
        print("ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œã‚’ä¸­æ­¢ã—ã¾ã—ãŸã€‚")


"""
ã€å®Ÿè¡Œæ–¹æ³•ã€‘
ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã€ä»¥ä¸‹ã®ã‚³ãƒžãƒ³ãƒ‰ã§Djangoã‚·ã‚§ãƒ«ã‚’èµ·å‹•ã—ã€ãã®ä¸­ã§å®Ÿè¡Œã§ãã¾ã™ã€‚

Djangoã‚·ã‚§ãƒ«ã‚’èµ·å‹•:
[Bash]
$python manage.py shell

ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦å®Ÿè¡Œ:
[Python]
>>> from core.scripts import fix_legacy_data
>>> fix_legacy_data.fix_legacy_unverified_users(dry_run=True)
"""
